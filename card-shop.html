<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>卡片商店 - 连接勇士</title>
    <link rel="stylesheet" href="./src/css/main.css">
    <link rel="stylesheet" href="./src/css/main-menu.css">
    <style>
        .shop-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .back-button {
            background-color: #555;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .back-button:hover {
            background-color: #777;
        }
        
        .shop-title {
            text-align: center;
            flex-grow: 1;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .card-item {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            background-color: #f9f9f9;
        }
        
        .card-item.rare-3 {
            border-color: #gold;
            background-color: #fff9db;
        }
        
        .card-item.rare-2 {
            border-color: #aaa;
            background-color: #eee;
        }
        
        .card-item.rare-1 {
            border-color: #cd7f32;
            background-color: #fdf5e6;
        }
        
        .card-name {
            font-weight: bold;
            margin: 5px 0;
        }
        
        .card-cost {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .buy-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 5px;
        }
        
        .buy-button:hover {
            background-color: #45a049;
        }
        
        .buy-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .stars-display {
            font-size: 18px;
            font-weight: bold;
            color: gold;
        }
    </style>
</head>
<body>
    <div class="shop-container">
        <div class="page-header">
            <button id="back-button" class="back-button">返回主菜单</button>
            <h1 class="shop-title">卡片商店</h1>
            <div class="stars-display">星点：<span id="stars-count">0</span></div>
        </div>
        
        <div class="cards-grid" id="cards-container">
            <!-- 卡片将通过JavaScript动态加载 -->
        </div>
    </div>

    <script src="./js/jquery-3.4.1.js"></script>
    <script src="./src/data/CardData.js"></script>
    <script>
        $(document).ready(function() {
            // 加载游戏数据
            var gameData = JSON.parse(localStorage.getItem('LinkWarriorGameData'));
            
            if (!gameData) {
                alert('请先创建游戏数据！');
                window.location.href = 'index.html';
                return;
            }
            
            // 显示星点数量
            $('#stars-count').text(gameData.stars || 0);
            
            // 返回按钮
            $('#back-button').on('click', function() {
                window.location.href = 'index.html';
            });
            
            // 显示可购买的卡片
            renderShopCards();
        });
        
        function renderShopCards() {
            var cardsContainer = $('#cards-container');
            cardsContainer.empty();
            
            // 获取所有卡片并按稀有度排序
            var allCards = CardData.getAllCards();
            
            // 按稀有度排序（3级到1级）
            allCards.sort(function(a, b) {
                return b.rarity - a.rarity;
            });
            
            // 显示卡片
            allCards.forEach(function(card) {
                var cost = calculateCardCost(card);
                
                var cardElement = `
                    <div class="card-item rare-${card.rarity}">
                        <div class="card-name">${card.name}</div>
                        <div class="card-rarity">稀有度：${getRarityText(card.rarity)}</div>
                        <div class="card-cost">价格：${cost} 星点</div>
                        <button class="buy-button" data-card-id="${card.id}" data-cost="${cost}">购买</button>
                    </div>
                `;
                
                cardsContainer.append(cardElement);
            });
            
            // 绑定购买按钮事件
            $('.buy-button').on('click', function() {
                var cardId = $(this).data('card-id');
                var cost = $(this).data('cost');
                
                buyCard(cardId, cost);
            });
        }
        
        function calculateCardCost(card) {
            // 根据稀有度计算价格
            switch(card.rarity) {
                case 3: return 100;
                case 2: return 50;
                case 1: return 20;
                default: return 10;
            }
        }
        
        function getRarityText(rarity) {
            switch(rarity) {
                case 3: return '传说';
                case 2: return '稀有';
                case 1: return '普通';
                default: return '未知';
            }
        }
        
        function buyCard(cardId, cost) {
            var gameData = JSON.parse(localStorage.getItem('LinkWarriorGameData'));
            
            // 检查星点是否足够
            if ((gameData.stars || 0) < cost) {
                alert('星点不足！');
                return;
            }
            
            // 找到要购买的卡片
            var card = CardData.getCardById(cardId);
            if (!card) {
                alert('卡片不存在！');
                return;
            }
            
            // 检查背包是否已满（简单实现，实际可能需要更复杂的逻辑）
            if (gameData.inventory && gameData.inventory.length >= 20) {
                alert('背包已满，请先整理背包！');
                return;
            }
            
            // 扣除星点
            gameData.stars = (gameData.stars || 0) - cost;
            
            // 添加卡片到背包
            if (!gameData.inventory) {
                gameData.inventory = [];
            }
            
            // 创建卡片副本并添加唯一ID
            var cardCopy = Object.assign({}, card);
            cardCopy.uniqueId = card.id + '_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            
            gameData.inventory.push(cardCopy);
            
            // 保存游戏数据
            localStorage.setItem('LinkWarriorGameData', JSON.stringify(gameData));
            
            // 更新星点显示
            $('#stars-count').text(gameData.stars);
            
            alert(`成功购买 ${card.name}！`);
        }
    </script>
</body>
</html>